<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<title>Video Timeline</title>
<script src="jquery.js" type="text/javascript"></script>
<script src="popup.js" type="text/javascript"></script>
<script type='text/javascript'>
  function init_timeline(timeline, navmenu){
    $.ajax({
      url: '../api/videos.php?mode=list&limited=1',
      type: 'get',
      success: function(data){
        var tcats = JSON.parse(data);
        for( var tcat_id in tcats ){
          add_tcat(timeline, tcats[tcat_id]);
          add_tcat_nav(navmenu, tcats[tcat_id]);
        }
        init_event_handlers();
      }
    });
  }

  function init_event_handlers(){
    //CODE TO MAKE TIMELINE SCROLLABLE
    $('#timeline').mousedown(function (event) {
      $(this)
        .data('down', true)
        .data('x', event.clientX)
        .data('scrollLeft', this.scrollLeft);
            
        return false;
    }).mouseup(function (event) {
      $(this).data('down', false);
    }).mousemove(function (event) {
      if ($(this).data('down') == true) {
        this.scrollLeft = $(this).data('scrollLeft') + $(this).data('x') - event.clientX;
      }
    // Mousewheel does not always seem to work - SL
    // }).mousewheel(function (event, delta) {
    //     this.scrollLeft -= (delta * 30);
    }).css({
        'overflow' : 'hidden',
        'cursor' : '-moz-grab'
    });
    
    $(window).mouseout(function (event) {
      if ($('#timeline').data('down')) {
        try {
          if (event.originalTarget.nodeName == 'BODY' || event.originalTarget.nodeName == 'HTML') {
            $('#timeline').data('down', false);
          }                
        } catch (e) {}
      }
    });

    //CLICK ON YEAR TO EXPAND
    $('#access li').click(function() {
      var index = $(this).index();
      if ( $('#test li:eq(' + index + ')').width() == 1200 ){
        $('#test li:eq(' + index + ')').animate({'width': '300px'});
        $(this).animate({'width': '300px'})
        $('#test li .details').hide();
      }else{
        $('#test li:eq(' + index + ')').animate({'width': '1200px'}, "slow").siblings().animate({'width':'300px'});
        $(this).animate({'width': '1200px'}).siblings().animate({'width':'300px'});
        $('#test li:eq(' + index + ') .details').show();
      }
    });
	
    //CLICK ON YEAR TO SCROLL TO THAT YEAR
    $('#access li').bind('click',function(event){
    	var $anchor = $(this);
    	$('html, body').stop().animate({scrollLeft: $($anchor.attr('a href')).position().left}, 1000);
    	event.preventDefault();
  	});
    
  }

  function add_tcat(timeline, tcat_data){
    var tcat = document.createElement('li');
    tcat.setAttribute('id', 'tcat_'+tcat_data['id']);
    timeline.appendChild(tcat);
    var title = document.createElement('h3');
    if(tcat_data['link'] != ""){
      var title_link = document.createElement("a");
      title_link.setAttribute("href", tcat_data["link"]);
      title_link.setAttribute("target","_blank");
      title_link.innerHTML = tcat_data["name"];
      title.appendChild(title_link);
    }else{
      title.innerHTML = tcat_data['name'];
    }
    tcat.appendChild(title);
    var content = document.createElement('ul');
    content.setAttribute("class", "column");
    tcat.appendChild(content);
    //add_details!
    for(var i = 0; i < tcat_data["members"].length; i++){
      add_video(content, tcat_data.members[i]);
    }
    var details = document.createElement("div");
    details.setAttribute("class", "details");
    details.setAttribute("style", "display: none");
    if(tcat_data["description"] != ""){
      details.innerHTML = tcat_data["description"];
    }
    tcat.appendChild(details);
  }

  function add_video(container, video_data){
    var video = document.createElement('img');
    video.setAttribute("class", "video");
    video.setAttribute("id", video_data.id);
    video.setAttribute("src", video_data.key_frame);
    video.setAttribute("width", "96");
    video.setAttribute("height", "72");
    container.appendChild(video);
  }

  function add_tcat_nav(navmenu, tcat_data){
    var nav = document.createElement("li");
    nav.setAttribute("id", "menu-item-"+tcat_data['id']);
    nav.setAttribute("class", "menu-item");
    var link = document.createElement("a");
    link.setAttribute("href", "#tcat_"+tcat_data['id']);
    link.innerHTML = tcat_data['name_short'];
    nav.appendChild(link);
    navmenu.appendChild(nav);
  }

//Sends id of selected video to php script and returns information for popup.
  $(document).ready(function() {
    init_timeline(
      document.getElementById("test"),
      document.getElementById("menu-navigation-menu")
    );
    $('.video').dblclick(function() {
      $.ajax({
        url: 'timeline-relatedvideos.php',
        type: 'post',
        data:{id: $(this).attr('id')},
        success: function(value){
          $('#popup').html(value);
          //centers popup
          centerPopup();
          //loads popup
          loadPopup();
        }
      });
		});		
    //CLOSING POPUP
    //Click the x event
    $("#popupContactClose").click(function(){
      disablePopup();
    });
    //Click out event
    $("#backgroundPopup").click(function(){
      disablePopup();
    });
    //Press Escape event
    $(document).keypress(function(e){
      if(e.keyCode==27 && popupStatus==1){
        disablePopup();
      }
    });
  });
</script>
<link rel="stylesheet" href="timeline-popup.css" type="text/css" media="screen" />

</head>
<body>
<div id="timeline">
  <ul class="tl-events" id="test">
  </ul>
  <!---Tijdlijnbar--->
  <div id="t_footer">
    <div class="timeline-bar" style="width:7000px;height:30px;">
      <div id="access">
        <ul id="menu-navigation-menu" class="menu">
        </ul>
      </div>			
    </div>
  </div>
</div>

<!-- POPUP -->
<div id="popup">
</div>
</body>
</html>

